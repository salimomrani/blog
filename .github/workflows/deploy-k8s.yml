name: Deploy to Kubernetes

on:
  push:
    branches:
      - master
      - main
  workflow_dispatch: # Manual trigger

env:
  CERT_MANAGER_VERSION: v1.14.0

jobs:
  deploy:
    name: Deploy Application & SSL
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubeconfig
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBE_CONFIG_DATA" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Add cert-manager Helm repository
        run: |
          helm repo add jetstack https://charts.jetstack.io
          helm repo update

      - name: Install/Upgrade cert-manager
        run: |
          if kubectl get namespace cert-manager &> /dev/null; then
            echo "Upgrading cert-manager..."
            helm upgrade cert-manager jetstack/cert-manager \
              --namespace cert-manager \
              --version ${{ env.CERT_MANAGER_VERSION }} \
              --set installCRDs=true \
              --wait
          else
            echo "Installing cert-manager..."
            helm install cert-manager jetstack/cert-manager \
              --namespace cert-manager \
              --create-namespace \
              --version ${{ env.CERT_MANAGER_VERSION }} \
              --set installCRDs=true \
              --wait
          fi

      - name: Wait for cert-manager to be ready
        run: |
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/instance=cert-manager \
            -n cert-manager \
            --timeout=180s

      - name: Deploy ClusterIssuer
        run: |
          kubectl apply -f k8s/01-cluster-issuer-letsencrypt.yaml
          sleep 5
          kubectl get clusterissuer

      - name: Deploy Kubernetes manifests
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl apply -f k8s/ingress.yaml

      - name: Wait for certificate issuance
        run: |
          echo "Waiting for certificate to be issued..."
          for i in {1..24}; do
            if kubectl get certificate blog-frontend-tls-cert &> /dev/null; then
              CERT_READY=$(kubectl get certificate blog-frontend-tls-cert -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "False")

              if [ "$CERT_READY" == "True" ]; then
                echo "✅ Certificate is ready!"
                kubectl get certificate blog-frontend-tls-cert
                exit 0
              fi

              echo "Attempt $i/24: Certificate not ready yet (status: $CERT_READY)"
            else
              echo "Attempt $i/24: Certificate resource not found yet"
            fi

            sleep 10
          done

          echo "⚠️ Certificate not ready after 4 minutes"
          kubectl describe certificate blog-frontend-tls-cert || true
          exit 1

      - name: Deployment summary
        if: always()
        run: |
          echo "========================================="
          echo "Deployment Summary"
          echo "========================================="
          echo ""
          echo "Cert-manager pods:"
          kubectl get pods -n cert-manager
          echo ""
          echo "ClusterIssuers:"
          kubectl get clusterissuer
          echo ""
          echo "Certificates:"
          kubectl get certificate
          echo ""
          echo "Ingress:"
          kubectl get ingress blog-frontend-ingress
          echo ""
          echo "Application URL: https://blog.kubevpro.i-consulting.shop"
